resources:

- repo: self
  clean: true

variables:
  SamplesBin: SamplesBin
  WINDOWS_WINMD: C:\Program Files (x86)\Windows Kits\10\UnionMetadata\10.0.18362.0\Windows.winmd
  WindowsTargetPlatformVersion: 10.0.18362.0

strategy:
  maxParallel: 8
  matrix:
    Release_x64:
      BuildPlatform: x64
      BuildConfiguration: Release
    Debug_x64:
      BuildPlatform: x64
      BuildConfiguration: Debug
    Release_x86:
      BuildPlatform: x86
      BuildConfiguration: Release
    Debug_x86:
      BuildPlatform: x86
      BuildConfiguration: Debug

pool:
  name: DirectML_BuildPool
#  demands: agent.osversion -equals 10.0.17763

# CI trigger
trigger:
  branches:
    include:
    - master
  paths:
    exclude:
    - Tools

# PR validation trigger
pr:
  branches:
    include:
    - master
  paths:
    exclude:
    - Tools

steps: 
  # - task: PowerShell@2
  #   displayName: 'Check SDK Version 18362 is present'
  #   inputs:
  #     targetType: inline
  #     script: dir "${ENV:programfiles(x86)}\windows Kits\10\include\10.0.18362.0\"
    
  # - task: DotNetCoreInstaller@0
  #   displayName: 'Use .NET Core sdk 2.1.300'
  #   inputs:
  #     version: 2.1.300
  #   condition: succeededOrFailed()

  # - task: UseDotNet@2
  #   inputs:
  #     packageType: 'sdk'
  #     version: '5.0.x'

  # - task: NuGetToolInstaller@0
  #   displayName: 'Use NuGet 4.9.2'
  #   inputs:
  #     versionSpec: 4.9.2
  #   condition: succeededOrFailed()

  - task: NuGetToolInstaller@1
    displayName: 'Install NuGet 5.11.0'
    inputs:
      versionSpec: '5.11.0'

  # - task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
  #   displayName: 'NuGet restore'
  #   condition: succeededOrFailed()

  # - task: NuGetCommand@2
  #   displayName: "Package Restore"
  #   inputs:
  #     command: 'restore'
  #     restoreSolution: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery.sln'
  #     feedsToUse: 'config'
      
  # - task: NuGetCommand@2
  #   displayName: "Package Restore"
  #   inputs:
  #     command: 'restore'
  #     restoreSolution: 'Samples/WinMLSamplesGallery/packages.config'
  #     feedsToUse: 'select'
  #     restoreDirectory: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery (Package)/obj'

  # - task: NuGetCommand@2
  #   inputs:
  #     command: 'restore'
  #     restoreSolution: 'Samples/WinMLSamplesGallery/packages.config'
  #     feedsToUse: 'config'
  #     nugetConfigPath: 'Samples/WinMLSamplesGallery/NuGet.config'
  #     restoreDirectory: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery (Package)/obj'

# - task: DotNetCoreCLI@2
#   displayName: dotnet restore
#   inputs:
#     command: restore
#     projects: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery/WinMLSamplesGallery.csproj'
#     feedsToUse: 'select'
#     vstsFeed: '<projectName>/<feedName>'
#     includeNuGetOrg: true

  # - task: DotNetCoreCLI@2
  #   inputs:
  #     command: 'custom'
  #     custom: nuget locals all --clear

  - task: CmdLine@2
    displayName: "Clear NuGet Locals"
    inputs:
      script: 'C:\"Program Files"\dotnet\dotnet.exe nuget locals all --clear'

  - task: CmdLine@2
    displayName: "DotNet Restore"
    inputs:
      script: 'C:\"Program Files"\dotnet\dotnet.exe restore D:\a\_work\1\s\Samples\WinMLSamplesGallery\WinMLSamplesGallery\WinMLSamplesGallery.csproj --configfile D:\a\_work\1\s\Samples\WinMLSamplesGallery\NuGet.config'       

  # - task: DotNetCoreCLI@2
  #   displayName: "DotNet Restore csproj"
  #   inputs:
  #     command: 'restore'
  #     projects: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery/WinMLSamplesGallery.csproj'
  #     feedsToUse: 'config'
  #     nugetConfigPath: 'Samples/WinMLSamplesGallery/NuGet.config'

  # - task: DotNetCoreCLI@2
  #   displayName: "DotNet Restore waproj"
  #   inputs:
  #     command: 'restore'
  #     projects: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery (Package)/WinMLSamplesGallery (Package).wapproj'
  #     feedsToUse: 'config'
  #     nugetConfigPath: 'Samples/WinMLSamplesGallery/NuGet.config'


  # - task: CopyFiles@2
  #   displayName: "Copy package.assests.json into (Package) build"
  #   inputs:
  #     SourceFolder: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery/obj'
  #     Contents: 'project.assets.json'
  #     TargetFolder: 'Samples/WinMLSamplesGallery/WinMLSamplesGallery (Package)/obj'

  # - task: PowerShell@2
  #   displayName: "NugGet"

  # - task: VSBuild@1
  #   displayName: 'Build UI test solution Testing/**/SamplesTest.sln'
  #   inputs:
  #     solution: 'Testing/**/SamplesTest.sln'
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\SamplesTest\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build AdapterSelection Sample'
  #   inputs:
  #     solution: Samples/AdapterSelection/AdapterSelection.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\AdapterSelection\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build CustomOperator Sample'
  #   inputs:
  #     solution: Samples/CustomOperator/desktop/cpp/custom-operator-sample.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\CustomOperator\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()


  # - task: VSBuild@1
  #   displayName: 'Build MNIST-Tutorial-cs Sample'
  #   inputs:
  #     solution: 'Samples/MNIST/Tutorial/cs/mnist_demo.sln'
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\MNIST-Tutorial\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build MNIST-UWP-cs Sample'
  #   inputs:
  #     solution: 'Samples/MNIST/UWP/cs/mnist_demo.sln'
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\MNIST-cs\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build SqueezenetObjectDetection Sample'
  #   inputs:
  #     solution: Samples/SqueezeNetObjectDetection/squeezenetobjectdetection.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\SqueezeNetObjectDetection\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'	
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build FNSCandyStyleTransfer-UWP-CS Sample'
  #   inputs:
  #     solution: Samples/FNSCandyStyleTransfer/UWP/CS/snapcandy.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag  /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\FNSCandyStyleTransfer\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build MNIST-UWP-cppcx Sample'
  #   inputs:
  #     solution: 'Samples/MNIST/UWP/cppcx/mnist_cppcx.sln'
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\MNIST-cppcx\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build CustomTensorization Sample'
  #   inputs:
  #     solution: Samples/CustomTensorization/CustomTensorization.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\CustomTensorization\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build BatchSupport Sample'
  #   inputs:
  #     solution: Samples/BatchSupport/BatchSupport.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\BatchSupport\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build Emoji Sample'
  #   inputs:
  #     solution: Samples/Emoji8/UWP/cs/Emoji8.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\Emoji8\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build StreamFromResource Sample'
  #   inputs:
  #     solution: Samples/StreamFromResource/StreamFromResource.sln
  #     vsVersion: 15.0
  #     msbuildArgs: '-v:diag /p:OutDir=$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\StreamFromResource\ /p:WindowsTargetPlatformVersion=$(WindowsTargetPlatformVersion)'
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #     msbuildArchitecture: x64
  #     createLogFile: true
  #   condition: succeededOrFailed()

  # - task: VSBuild@1
  #   displayName: 'Build WinML Samples Gallery'
  #   inputs:
  #     solution: Samples/WinMLSamplesGallery/WinMLSamplesGallery.sln
  #     vsVersion: 16.0
  #     platform: '$(BuildPlatform)'
  #     configuration: '$(BuildConfiguration)'
  #     clean: true
  #   condition: succeededOrFailed()

  - task: CmdLine@2
    displayName: "Build WinMLSamplesGallery"
    inputs:
      script: 'C:\"Program Files (x86)"\"Microsoft Visual Studio"\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe "D:\a\_work\1\s\Samples\WinMLSamplesGallery\WinMLSamplesGallery.sln" /nologo /nr:false /p:_MSDeployUserAgent="VSTS_cb55739e-4afe-46a3-970f-1b49d8ee7564_build_39302_0" /p:Configuration=Debug /p:Platform=x64 /t:Clean,Build'

  - task: CopyFiles@2
    inputs:
      targetFolder: '$(Build.ArtifactStagingDirectory)\$(BuildPlatform)\$(BuildConfiguration)\'
      sourceFolder: '$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\'
      Contents: |
        **\SamplesTest\**
        **\AppPackages\**
    condition: succeededOrFailed()

  - task: CopyFiles@2
    inputs:
      targetFolder: '$(Build.ArtifactStagingDirectory)\$(BuildPlatform)\$(BuildConfiguration)\'
      sourceFolder: '$(System.DefaultWorkingDirectory)\bin\$(BuildPlatform)\$(BuildConfiguration)\'
      Contents: |
        ?(AdapterSelection|CustomOperator|CustomTensorization)**\*
        SqueezeNetObjectDetection\*
    condition: succeededOrFailed()

  - task: CopyFiles@2
    inputs:
      targetFolder: '$(Build.ArtifactStagingDirectory)\$(BuildPlatform)\$(BuildConfiguration)\SharedContent'
      sourceFolder: 'SharedContent'
      contents: '**\*'
    condition: succeededOrFailed()
   

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: Samples'
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: WinMLPublicSamples
    condition: succeededOrFailed()
